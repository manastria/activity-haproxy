---
title: "Partie 8 â€” SÃ©curiser lâ€™OS (pare-feu UFW & durcissement lÃ©ger)"
description: "Mise en place d'un pare-feu et de bonnes pratiques de sÃ©curisation sur la VM HAProxy."
sidebar:
  order: 2
status: "draft"
level: "BTS SIO 2"
duration: "45 min"
tags: ["haproxy", "tls", "sni", "bts-sio"]
---

:::note
Lâ€™objectif de cette partie est de fermer toutes les portes inutiles, de nâ€™ouvrir que ce que nÃ©cessite votre HAProxy, et dâ€™ajouter quelques bonnes pratiques OS sans complexitÃ©.
:::

## 1. PrÃ©requis

Avant de commencerÂ :
* Debian 12 Ã  jour sur la VM **HaProxy**.
* IPs et interfaces dÃ©jÃ  configurÃ©es (parties prÃ©cÃ©dentes).
* Vous connaissez les **ports** nÃ©cessairesÂ :
    * **22/tcp** (SSH administrateur)
    * **80/tcp** (HTTP â†’ redirection)
    * **443/tcp** (HTTPS)
    * **8404/tcp** (page de stats HAProxy, **depuis le Labo uniquement**)

:::tip
RÃ©seaux de rÃ©fÃ©rence du TPÂ : Labo = 172.25.0.0/16, DMZ backends = 10.10.0.0/24.
:::

---

## 2. Installer & activer UFW

```bash
sudo apt-get update
sudo apt-get install -y ufw
````

### 2.1. DÃ©finir la politique par dÃ©faut

```bash
# Bloquer tout ce qui arrive par dÃ©faut
sudo ufw default deny incoming
# Autoriser tout ce qui sort par dÃ©faut (simplifie le TP)
sudo ufw default allow outgoing
```

:::note
Lâ€™idÃ©e est de partir dâ€™un Ã©tat Â«â€¯fermÃ©â€¯Â» et dâ€™ouvrir ce qui est utile. La sortie `full-allow` est suffisante pour ce TP (mises Ã  jour, `apt`, etc.). En production, on pourrait restreindre les sorties (voir section 6.3).
:::

-----

## 3. Ouvrir proprement les services utiles

### 3.1. SSH (22/tcp)

Option A (simple) â€” autoriser tout le LaboÂ :

```bash
sudo ufw allow from 172.25.0.0/16 to any port 22 proto tcp
```

:::tip
Si vous administrez depuis un poste unique, prÃ©fÃ©rez nâ€™autoriser que son IP.
:::

### 3.2. HTTP/HTTPS (80/443)

```bash
sudo ufw allow from 172.25.0.0/16 to any port 80 proto tcp
sudo ufw allow from 172.25.0.0/16 to any port 443 proto tcp
```

### 3.3. Page de statistiques (8404) **restreinte**

```bash
sudo ufw allow from 172.25.0.0/16 to any port 8404 proto tcp
```

:::note
Ne pas exposer cette page de statistiques Ã  tout le monde.
:::

### 3.4. (Option) Pinger la VM (ICMP)

UFW ne gÃ¨re pas ICMP par des rÃ¨gles Â«â€¯allowâ€¯Â» classiques. Pour un TP, on peut laisser le ping par dÃ©faut (autorisÃ©). Si vous voulez le bloquer, il faudrait le faire avec `nftables` (en bonus).

-----

## 4. Activer UFW en sÃ©curitÃ©

Avant dâ€™activer, **vÃ©rifiez** que vous avez bien autorisÃ© **votre** accÃ¨s SSH (sinon vous risquez de vous couper lâ€™accÃ¨s ğŸ˜…).

```bash
# Relire les rÃ¨gles
sudo ufw status verbose

# Activer
sudo ufw enable

# Voir la numÃ©rotation pratique
sudo ufw status numbered
```

Test rapide depuis un poste du LaboÂ :

  * `curl -I http://IP_HAPROXY/` â†’ **OK**
  * `curl -I https://IP_HAPROXY/` â†’ **OK**
  * `curl -I http://IP_HAPROXY:8404/haproxy?stats` â†’ **401** (puis OK avec login)
  * Depuis une IP hors labo, lâ€™accÃ¨s doit Ãªtre **refusÃ©**.

-----

## 5. Journalisation et contrÃ´le

### 5.1. Activer un niveau de logs raisonnable

```bash
sudo ufw logging low
```

Consulter les logsÂ :

```bash
sudo journalctl -u ufw -f
```

### 5.2. Bloquer temporairement (test)

```bash
# Bloquer les requÃªtes HTTP
sudo ufw deny from 172.25.0.0/16 to any port 80

# Testez que HTTP ne passe plus, puis remettez :
sudo ufw delete deny from 172.25.0.0/16 to any port 80
```

-----

## 6. Durcissement lÃ©ger (sans complexitÃ©)

### 6.1. SSH un peu plus strict

Ã‰ditez `/etc/ssh/sshd_config`Â :

```
PermitRootLogin no
PasswordAuthentication no
```

PuisÂ :

```bash
sudo systemctl reload ssh
```

:::tip
Utilisez des clÃ©s SSH (pas de mot de passe). Assurez-vous dâ€™avoir dÃ©jÃ  votre clÃ© autorisÃ©e dans `~/.ssh/authorized_keys` avant de couper lâ€™authentification par mot de passe.
:::

### 6.2. Mises Ã  jour de sÃ©curitÃ© automatiques

```bash
sudo apt-get install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

### 6.3. (Option) Restreindre **les sorties** du proxy

Si vous voulez Ãªtre plus strictÂ : nâ€™autoriser en sortie que ce qui sert au TP (backends DMZ + DNS/NTP/Apt). Exemple minimalÂ :

```bash
sudo ufw default deny outgoing

# DNS vers le pare-feu/resolveur du Labo (adapter IP)
sudo ufw allow out to 172.25.254.254 port 53 proto udp
sudo ufw allow out to 172.25.254.254 port 53 proto tcp
# HTTP/HTTPS vers dÃ©pÃ´ts Debian (si besoin dâ€™apt depuis HaProxy)
sudo ufw allow out to any port 80 proto tcp
sudo ufw allow out to any port 443 proto tcp
# Vers backends DMZ (HTTP ou HTTPS selon votre choix)
sudo ufw allow out to 10.10.0.0/24 port 80 proto tcp
sudo ufw allow out to 10.10.0.0/24 port 443 proto tcp
```

:::tip
Cette configuration est plus sÃ»re, mais aussi plus facile Ã  casser. Pour ce TP, `allow outgoing` suffit.
:::

### 6.4. (Option) Fail2ban (protection SSH)

```bash
sudo apt-get install -y fail2ban
sudo systemctl enable --now fail2ban
```

:::note
Par dÃ©faut, il protÃ¨ge dÃ©jÃ  SSH. Il est utile en dÃ©mo dâ€™une Â«â€¯attaque brute-forceâ€¯Â».
:::

-----

## 7. DÃ©pannage rapide

  * **Â«â€¯Je me suis coupÃ© lâ€™accÃ¨s SSHâ€¯Â»**
      * Console VirtualBox â†’ `sudo ufw disable` â†’ corrigez les rÃ¨gles â†’ `sudo ufw enable`.
  * **Â«â€¯Le site HTTPS ne rÃ©pond plusâ€¯Â»**
      * `sudo ufw status`Â : le port 443 est-il autorisÃ© depuis votre rÃ©seauÂ ?
      * `ss -lntp | grep :443`Â : HAProxy Ã©coute-t-il bienÂ ?
      * `journalctl -u ufw -f` / `journalctl -u haproxy -f`Â : des logs bloquantsÂ ?
  * **Â«â€¯Stats 8404 inaccessiblesâ€¯Â»**
      * VÃ©rifiez la **source IP** (hors 172.25.0.0/16 â†’ refus normal).
      * Autorisez **temporairement** toute source pour tester (puis revenez en arriÃ¨re).

-----

## 8. Validation

1.  `sudo ufw status verbose` montreÂ :
      * `deny (incoming)`, `allow (outgoing)`
      * les rÃ¨gles `22`, `80`, `443`, `8404` **depuis 172.25.0.0/16**.
2.  `curl -I` depuis le Labo â†’ **OK**Â ; hors Labo â†’ **REFUS**.
3.  SSH reste **accessible** depuis votre poste.
4.  Les logs UFW remontent dans `journalctl`.

-----

## 9. Ã€ retenir

:::caution

  * **UFW** est la voie simple pour **sÃ©curiser rapidement** une VM Debian (politiques par dÃ©faut, rÃ¨gles claires, logs).
  * Nâ€™ouvrez **que** ce qui est nÃ©cessaire (22, 80, 443, 8404 depuis le Labo).
  * Un **durcissement lÃ©ger** (SSH par clÃ©, MAJ auto) apporte beaucoup pour peu dâ€™effort.
  * Pour aller plus loinÂ : passer Ã  **`nftables` natif** (mÃªmes concepts, syntaxe plus fine).
:::

